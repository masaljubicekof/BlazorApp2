@page "/projects"
@inject SupaClient Supa
@inject AppState State

<h3>Projects</h3>

<div class="mb-3">
    <label class="form-label">New project</label>
    <input class="form-control" @bind="newName" placeholder="Enter project name" />
    <small class="form-text text-muted">This will be the name of your project</small>
</div>

<button class="btn btn-success mb-3" @onclick="Add">Add</button>

<ul>
@foreach (var p in items)
{
  <li>
    <a href="@($"/projects/{p.id}")">@p.name</a>
    <button @onclick="(()=> Delete(p))">X</button>
  </li>
}
</ul>

@if (!string.IsNullOrWhiteSpace(msg))
{
    <div class="alert alert-info alert-dismissible fade show mt-3" role="alert">
        @msg
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}


@code {
  List<Project> items = new();
  string newName = "";
  string msg = "";

  protected override async Task OnInitializedAsync() => await Load();

  async Task Load(){
    try { items = await Supa.GetProjects(); }
    catch(Exception ex){ msg = ex.Message; }
  }

  async Task Add(){
    var uid = State.CurrentUserId ?? Guid.Empty; if (uid==Guid.Empty){ msg="Uloguj se."; return; }
    if (string.IsNullOrWhiteSpace(newName)) return;
    try{
      var p = await Supa.AddProject(newName, uid);
      if (p!=null) items.Insert(0, p);
      newName="";
    } catch(Exception ex){ msg = ex.Message; }
  }

  async Task Delete(Project p){
    try{
      await Supa.DeleteProject(p.id);
      items.RemoveAll(x=>x.id==p.id);
    } catch(Exception ex){ msg = ex.Message; }
  }
}
